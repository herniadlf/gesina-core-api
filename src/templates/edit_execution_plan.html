{% extends "layout.html" %}
{% block content %}
    <div>
        <div class="d-flex justify-content-between pb-4">
                <h2>Editar plan de ejecucion</h2>
        </div>
        <div class="container-xxl">
            <form method=post
                  enctype=multipart/form-data
                  class="p-4 container needs-validation"
                  id="execution-plan-form"
                  action="{{ url_for("view_controller.save_execution_plan") }}">
                <!-- Ojo con esto por favor -->
                    <!-- Nombre del plan -->
                    <div class="form-group" style="display: flex; flex-direction: column; align-items: flex-start;">
                        <label for="plan_name" style="margin-bottom: 5px;"><h5>Nombre del plan</h5></label>
                        <input class="form-control" id="plan_name" name="plan_name">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <label id="no_changes_label" style="color: green; display: none;">Se actualizará el campo</label>
                            <label id="reset_label" style="color: red; cursor: pointer; display: none;">Restablecer valores iniciales</label>
                        </div>
                    </div>
                    <!-- Geometría del plan -->
                    <!----------------------------------------------------------------------- 
                        Acá el objeto geometry tiene que tener todas las geometrias cargadas 
                        como en la linea 205 del archivo view_controller.py
                    ------------------------------------------------------------------------>
                    <div class="form-group">
                        <label for="status-select"><h5>Geometría</h5></label>
                        <select class="custom-select" id="status-select" name="geometry_option">
                            <!-- Only for testing -->
                            <option value="opcion1">Opcin 1</option>
                            <option value="opcion2">Opcin 2</option>
                            <option value="opcion3">Opcin 3</option>
                            <option value="opcion4">Opcin 4</option>
                            <!---------------------->
                        </select>
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <label id="no_changes_label_geometry" style="color: green; display: none;">Se actualizará el campo</label>
                            <label id="reset_label_geometry" style="color: red; cursor: pointer; display: none;">Restablecer valores iniciales</label>
                        </div>
                    </div>
                    <!-- Carga del project file -->
                    <div class="form-group">
                        <label for="projectFileUpload"><h5>Proyecto</h5></label>
                        <input type="file" name="project_file" class="form-control-file" id="projectFileUpload">
                        <input type="hidden" name="project_file_name" id="projectFileName">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <label id="no_changes_label_project_file" style="color: green; display: none;">Se actualizará el campo</label>
                            <label id="file_info_label" style="color: blue; display: inline-block;">El valor inicial del campo esta seleccionado, para modificarlo por favor seleccione un archivo.</label>
                            <label id="reset_label_project_file" style="color: red; cursor: pointer; display: none;">Restablecer valores iniciales</label>
                        </div>
                    </div>
                    <!-- Carga del plan file -->
                    <div class="form-group">
                        <label for="planFileUpload"><h5>Plan</h5></label>
                        <input type="file" name="plan_file" class="form-control-file" id="planFileUpload">
                        <input type="hidden" name="plan_file_name" id="planFileName">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <label id="no_changes_label_plan_file" style="color: green; display: none;">Se actualizará el campo</label>
                            <label id="file_info_label_plan" style="color: blue; display: inline-block;">El valor inicial del campo esta seleccionado, para modificarlo por favor seleccione un archivo.</label>
                            <label id="reset_label_plan_file" style="color: red; cursor: pointer; display: none;">Restablecer valores iniciales</label>
                        </div>
                    </div>
                    <!-- Carga de Condiciones de borde file -->
                    <div class="form-group">
                        <label for="flowFileUpload"><h5>Condiciones de borde</h5></label>
                        <input type="file" name="flow_file" class="form-control-file" id="flowFileUpload">
                        <input type="hidden" name="plan_file_name" id="cdbFileName">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <label id="no_changes_label_cdb_file" style="color: green; display: none;">Se actualizará el campo</label>
                            <label id="file_info_label_cdb" style="color: blue; display: inline-block;">El valor inicial del campo esta seleccionado, para modificarlo por favor seleccione un archivo.</label>
                            <label id="reset_label_cdb_file" style="color: red; cursor: pointer; display: none;">Restablecer valores iniciales</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="restartFileUpload"><h5>Restart File</h5></label>
                        <input type="file" name="restart_file" class="form-control-file" id="restartFileUpload">
                    </div>
                    <div class="form-group">
                        <h5>ACA HABIA UN FORM</h5>
                        <table class="table" id="execution_plan_output_table">
                              <thead>
                                <tr>
                                  <th scope="col">#</th>
                                  <th scope="col">River</th>
                                  <th scope="col">Reach</th>
                                  <th scope="col">River stat</th>
                                  <th scope="col">Acciones</th>
                                </tr>
                              </thead>
                              <tbody id="execution_plan_output_table_body">
                                    <tr>
                                        <th scope="row">aca habia otra cosa</th>
                                        <td>aca habia un form</td>
                                        <td>aca habia un form</td>
                                        <td>aca habia un form</td>
                                        <td><button type="button" class="btn btn-danger remove-row-execution-plan-output">&#8722;</button></td>
                                    </tr>
                              </tbody>
                        </table>
                        <button id="add-row-execution-plan" type="button" class="btn btn-success">&#43;</button>
                        <button id="clear-row-execution-plan" type="button" class="btn btn-danger">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    <div class="text-right">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                    <!-- Ojo con esto por favor -->
            </form>
        </div>
    </div>
    <script>            
        var initialValuePlanValue = '';
        var geometrySelectorInitialValue = '';
        var projectFileInitialValue = '';
        var planFileInitialValue = '';
        var cdbFileInitialValue = '';

        window.onload = function() {
            // -----------------Plan name----------------- //
            var planNameInput = document.getElementById('plan_name');

            getParameterByName('plan_name')
                .then(function (planNameFromUrl) {
                    if (planNameInput) {
                        planNameInput.value = planNameFromUrl || '';
                    }
                    initialValuePlanValue = planNameInput.value;
            })
            .catch(function (error) {
                console.error('Error al obtener el parámetro del nombre del plan:', error);
            });

            // -----------------Geometria----------------- //
            var geometryInput = document.getElementById('status-select');

            getParameterByName('Geometria')
                .then(function (geometryFromUrl) {
                    var geometryFromUrlOption = document.createElement("option");
                    geometryFromUrlOption.text = geometryFromUrl;
                    geometryFromUrlOption.value = geometryFromUrl;

                    geometryInput.add(geometryFromUrlOption);

                    if (geometryInput) {
                        geometryInput.value = geometryFromUrl || '';
                    }
                    geometrySelectorInitialValue = geometryInput.value;
            })
            .catch(function (error) {
                console.error('Error al obtener el parámetro de la geometria:', error);
            });

            // -----------------Project File----------------- //
            var projectFile = document.getElementById('projectFileUpload');
            var projectFileName = document.getElementById('projectFileName');

            getParameterByName('Proyecto')
                .then(function (projectFileFromUrl) {
                    if (projectFile) {
                        projectFileName.value = projectFileFromUrl || ''; 
                    }
                    projectFileInitialValue = projectFileFromUrl || '';
            })
            .catch(function (error) {
                console.error('Error al obtener el parámetro del nombre de archivo del proyecto:', error);
            });          

            // -----------------Plan File----------------- //
            var planFile = document.getElementById('planFileUpload');
            var planFileName = document.getElementById('planFileName');

            getParameterByName('Plan')
                .then(function (planFileFromUrl) {
                    if (planFile) {
                        planFileName.value = planFileFromUrl[0] || ''; 
                    }
                    planFileInitialValue = planFileFromUrl[0] || '';
            })
            .catch(function (error) {
                console.error('Error al obtener el parámetro del nombre de archivo del plan:', error);
            }); 

            // -----------------Condiciones de Borde File----------------- //
            var cdbFile = document.getElementById('flowFileUpload');
            var cdbFileName = document.getElementById('cdbFileName');

            getParameterByName('Condicion de Borde')
                .then(function (cdbFileFromUrl) {
                    if (planFile) {
                        cdbFileName.value = cdbFileFromUrl[0] || ''; 
                    }
                    cdbFileInitialValue = cdbFileFromUrl[0] || '';
            })
            .catch(function (error) {
                console.error('Error al obtener el parámetro del nombre de archivo de las condiciones de borde:', error);
            }); 
        }

        $('#startDateInput').datepicker({
            language: 'es',
            clearBtn: true,
            startDate: new Date(2021, 0, 0),
            endDate: "0d"
        });
        $('#endDateInput').datepicker({
            language: 'es',
            clearBtn: true,
            startDate: new Date(2021, 0, 0),
            endDate: "0d"
        });

        function removeRowListener(selector) {
            $( selector ).off("click")
            $( selector ).on("click", function() {
                $(this).parent().parent().remove();
            });
        }

        $( "#add-row-execution-plan" ).on("click", function() {
            let idx = 0
            tr = $("#execution_plan_output_table_body tr:last-child")
            if( tr.length ){
                idx = $("#execution_plan_output_table_body tr:last-child th")[0].textContent
                idx = parseInt(idx)
            }

            new_row = `
                <tr>
                    <th scope="row">${idx + 1}</th>
                    <td><input id="execution_plan_output_list-${idx}-river" name="execution_plan_output_list-${idx}-river" required="" type="text" value=""></td>
                    <td><input id="execution_plan_output_list-${idx}-reach" name="execution_plan_output_list-${idx}-reach" required="" type="text" value=""></td>
                    <td><input id="execution_plan_output_list-${idx}-river_stat" name="execution_plan_output_list-${idx}-river_stat" required="" type="text" value=""></td>
                    <td><button type="button" class="btn btn-danger remove-row-execution-plan-output">−</button></td>
                </tr>
            `

            $( "#execution_plan_output_table_body" ).append( new_row );
            removeRowListener(".remove-row-execution-plan-output")
        });

        function getParameterByName(name) {
            return new Promise(function (resolve, reject) {
                url = window.location.href;
        
                var queryString = url.split('=');
        
                let edit_url = `{{ url_for('api_controller.get_execution_plan', execution_plan_id='') }}${queryString[1]}`;
        
                fetch(edit_url, { method: 'GET' })
                    .then(response => response.json())
                    .then(data => {
                        plan_name = data.plan_name;
        
                        files = getFileNames(data);
                        
                        if (name == 'plan_name') {
                            resolve(plan_name);
                        } else {
                            resolve(files[name]);
                        }
                    })
                    .catch(error => {
                        console.error('Error al intentar el comienzo de edición de la simulación', error);
                        reject(error);
                    });
            });
        }

        function getFileNames(data){
            var extension = new Array();
            var extensionesPorTipo = {};

            var planes = new Array();
            var condicionesDeBorde = new Array();

            extensionesPorTipo['Nombre de plan'] = data.plan_name
            extensionesPorTipo['Plan'] = planes
            extensionesPorTipo['Condicion de Borde'] = condicionesDeBorde

            for (var clave in data.files) {
                valor = data.files[clave]
                
                var palabras = valor.split('.');

                if (palabras[1][0] == 'g'){
                    extensionesPorTipo['Geometria'] = valor;
                } else if (palabras[1] == 'prj'){
                    extensionesPorTipo['Proyecto'] = valor;
                } else if (palabras[1][0] == 'p'){
                    extensionesPorTipo['Plan'].push(valor);
                } else if (palabras[1][0] == 'u'){
                    extensionesPorTipo['Condicion de Borde'].push(valor);
                } else if (palabras[1] == 'rst'){
                    extensionesPorTipo['Restart File'] = valor;
                }
            }

            return extensionesPorTipo
        }

        document.addEventListener('DOMContentLoaded', function () {
            var planNameInput = document.getElementById('plan_name');
            var noChangesLabel = document.getElementById('no_changes_label');
            var resetLabel = document.getElementById('reset_label');
            
            var geometrySelector = document.getElementById('status-select');
            var noChangesLabelGeometry = document.getElementById('no_changes_label_geometry');
            var resetLabelGeometry = document.getElementById('reset_label_geometry');

            var projectFileUpload = document.getElementById('projectFileUpload');
            var projectFileName = document.getElementById('projectFileName');
            var noChangesLabelProjectFile = document.getElementById('no_changes_label_project_file');
            var resetLabelProjectFile = document.getElementById('reset_label_project_file');
            var fileInfoLabel = document.getElementById('file_info_label');

            var planFileUpload = document.getElementById('planFileUpload');
            var planFileName = document.getElementById('planFileName');
            var noChangesLabelPlanFile = document.getElementById('no_changes_label_plan_file');
            var resetLabelPlanFile = document.getElementById('reset_label_plan_file');
            var filePlanInfoLabel = document.getElementById('file_info_label_plan');

            var cdbFileUpload = document.getElementById('flowFileUpload');
            var cdbFileName = document.getElementById('cdbFileName');
            var noChangesLabelCdbFile = document.getElementById('no_changes_label_cdb_file');
            var resetLabelCdbFile = document.getElementById('reset_label_cdb_file');
            var fileCdbInfoLabel = document.getElementById('file_info_label_cdb');
            
            document.getElementById('plan_name').addEventListener('input', function () {
                var currentValue = this.value;

                if (currentValue === initialValuePlanValue) {
                    noChangesLabel.style.display = 'none';
                    resetLabel.style.display = 'none';
                } else {
                    noChangesLabel.style.display = 'inline-block';
                    resetLabel.style.display = 'inline-block';
                }
            });

            resetLabel.addEventListener('click', function () {
                document.getElementById('plan_name').value = initialValuePlanValue;
                noChangesLabel.style.display = 'none'; 
                resetLabel.style.display = 'none'; 
            });

            geometrySelector.addEventListener('change', function () {
                var currentValue = this.value;

                if (currentValue === geometrySelectorInitialValue) {
                    noChangesLabelGeometry.style.display = 'none';
                    resetLabelGeometry.style.display = 'none';
                } else {
                    noChangesLabelGeometry.style.display = 'inline-block';
                    resetLabelGeometry.style.display = 'inline-block';
                }
            });

            resetLabelGeometry.addEventListener('click', function () {
                geometrySelector.value = geometrySelectorInitialValue;
                noChangesLabelGeometry.style.display = 'none'; 
                resetLabelGeometry.style.display = 'none'; 
            });

            projectFileUpload.addEventListener('input', function () {
                var currentValue = this.files[0].name;

                if (currentValue === projectFileInitialValue) {
                    noChangesLabelProjectFile.style.display = 'none';
                    resetLabelProjectFile.style.display = 'none';
                    fileInfoLabel.style.display = 'inline-block';
                } else {
                    fileInfoLabel.style.display = 'none';
                    noChangesLabelProjectFile.style.display = 'inline-block';
                    resetLabelProjectFile.style.display = 'inline-block';
                    
                }
            });

            resetLabelProjectFile.addEventListener('click', function () {
                projectFileName.value = projectFileInitialValue;
                noChangesLabelProjectFile.style.display = 'none'; 
                resetLabelProjectFile.style.display = 'none'; 
                fileInfoLabel.style.display = 'inline-block';
            });

            planFileUpload.addEventListener('input', function () {
                var currentValue = this.files[0].name;

                if (currentValue === planFileInitialValue) {
                    noChangesLabelPlanFile.style.display = 'none';
                    resetLabelPlanFile.style.display = 'none';
                    filePlanInfoLabel.style.display = 'inline-block';
                } else {
                    filePlanInfoLabel.style.display = 'none';
                    noChangesLabelPlanFile.style.display = 'inline-block';
                    resetLabelPlanFile.style.display = 'inline-block';
                    
                }
            });

            resetLabelPlanFile.addEventListener('click', function () {
                planFileName.value = planFileInitialValue;
                noChangesLabelPlanFile.style.display = 'none'; 
                resetLabelPlanFile.style.display = 'none'; 
                filePlanInfoLabel.style.display = 'inline-block';
            });            

            cdbFileUpload.addEventListener('input', function () {
                var currentValue = this.files[0].name;

                if (currentValue === cdbFileInitialValue) {
                    noChangesLabelCdbFile.style.display = 'none';
                    resetLabelCdbFile.style.display = 'none';
                    fileCdbInfoLabel.style.display = 'inline-block';
                } else {
                    fileCdbInfoLabel.style.display = 'none';
                    noChangesLabelCdbFile.style.display = 'inline-block';
                    resetLabelCdbFile.style.display = 'inline-block';
                    
                }
            });

            resetLabelCdbFile.addEventListener('click', function () {
                cdbFileName.value = cdbFileInitialValue;
                noChangesLabelCdbFile.style.display = 'none'; 
                resetLabelCdbFile.style.display = 'none'; 
                fileCdbInfoLabel.style.display = 'inline-block';
            });
        });

    </script>
    <style>
        .datepicker {
            border-radius: 0.25rem;
            border-color: lightgray;
        }
    </style>

{% endblock %}